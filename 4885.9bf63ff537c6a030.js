"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4885],{4885:(v,E,c)=>{c.d(E,{c:()=>R});var f=c(467),i=c(4341),e=c(4438),s=c(4742),_=c(9167),g=c(7568),C=c(3511),d=c(7578),p=c(177);function O(a,h){if(1&a&&(e.j41(0,"ion-select-option",19),e.EFF(1),e.k0s()),2&a){const r=h.$implicit;e.Y8G("value",r),e.R7$(),e.Lme("",r.ID,"--",r.NOMBRE," ")}}function D(a,h){if(1&a&&(e.j41(0,"ion-select-option",19),e.EFF(1),e.k0s()),2&a){const r=h.$implicit;e.Y8G("value",r.NOMBRE),e.R7$(),e.SpI(" ",r.NOMBRE," ")}}function M(a,h){if(1&a){const r=e.RV6();e.j41(0,"ion-button",27),e.bIt("click",function(){e.eBV(r);const o=e.XpG().index,n=e.XpG();return e.Njj(n.removeInputField(o))}),e.nrm(1,"ion-icon",2),e.EFF(2," eliminar "),e.k0s()}}function A(a,h){if(1&a){const r=e.RV6();e.j41(0,"section",20)(1,"ion-item-group")(2,"ion-item-divider",21),e.EFF(3),e.k0s(),e.j41(4,"ion-item")(5,"ion-select",22),e.bIt("ionChange",function(o){const n=e.eBV(r).index,l=e.XpG();return e.Njj(l.onChangeConcepto(o,n))}),e.DNE(6,D,2,2,"ion-select-option",8),e.k0s()(),e.j41(7,"ion-item")(8,"ion-label",23),e.EFF(9,"Mes:"),e.k0s(),e.nrm(10,"ion-datetime",24),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",25),e.k0s(),e.DNE(13,M,3,0,"ion-button",26),e.k0s()()}if(2&a){const r=h.index,t=e.XpG();e.Y8G("formGroupName",r),e.R7$(3),e.SpI("Conceptos #",r+1,""),e.R7$(3),e.Y8G("ngForOf",t.conceptos),e.R7$(4),e.Y8G("preferWheel",!0),e.R7$(3),e.Y8G("ngIf",t.conceptoForm.length>1)}}let R=(()=>{var a;class h{constructor(t,o,n,l,m,u,b){this.modalCtrl=t,this.actionSheetCtrl=o,this.formBuilder=n,this.service=l,this.loadingUtil=m,this.toastUtil=u,this.alertUtil=b,this.item={FOLIO:0,CASA:"",NOMBRE:"",CANTIDAD:"",CONCEPTO:"",FECHA:"",CORREO:"",INPUT_TIMESTAMP:""},this.itemDetail=[],this.casas=[],this.conceptos=[],this.data=!1,this.sendEmail=!1,this.date=new Date,this.today=new Date(this.date.getTime()-6e4*this.date.getTimezoneOffset()),this.fields=this.formBuilder.group({folio:["",i.k0.required],casa:["",i.k0.required],nombre:["",i.k0.required],fecha:["",i.k0.required],email:["",i.k0.required],sendEmail:"",cantidad:["",i.k0.required],conceptos:this.formBuilder.array([this.frmConceptos()])})}frmConceptos(){return this.formBuilder.group({concepto:["",[i.k0.required,i.k0.minLength(3)]],mes:["",[i.k0.required]],monto:["",[i.k0.required,i.k0.min(0),i.k0.pattern(/^\d+(\.\d{1,2})?$/)]]})}get conceptoForm(){return this.fields.get("conceptos")}ngOnInit(){this.service.getSpreadSheetId().then(()=>{const t=this.today.toJSON().split("T")[0];this.fields.patchValue({fecha:t}),this.inittial()}),this.loadingUtil.showing()}getMaxFolio(){this.service.getFullDataDetail().subscribe({next:t=>{const o=Math.max(...t.map(n=>n.FOLIO))+1;this.fields.patchValue({folio:o}),this.loadingUtil.dismiss()},error:t=>{this.fields.patchValue({folio:1}),this.loadingUtil.dismiss(),this.alertUtil.showError("No se pudo obtener el folio: "+t.message)}})}inittial(){var o,t=this;this.service.getFullData().subscribe({next:o=>{this.casas=o||[],this.service.getConceptos().subscribe(n=>{this.conceptos=n||[],this.getMaxFolio()})},error:(o=(0,f.A)(function*(n){console.error("Error al cargar datos:",n),t.loadingUtil.dismiss(),t.alertUtil.showError("No se pudieron cargar los datos: "+n.message)}),function(l){return o.apply(this,arguments)})})}onChangeCasa(t){const o=t.detail.value;o.ID&&(this.casa=this.casas.find(n=>n.ID===o.ID&&n.NOMBRE===o.NOMBRE?n:null),this.fields.patchValue({nombre:this.casa.NOMBRE,email:this.casa.EMAIL,sendEmail:!0}))}onChangeConcepto(t,o){if(t.detail.value){const l=this.fields.controls.conceptos;let m=this.calMontoConcepto();l.at(o).patchValue({mes:this.getFirstDayOfMonth(),monto:m})}}calMontoConcepto(){let o=0;return this.fields.controls.conceptos.controls.forEach(n=>{o+=n.value.monto}),this.fields.value.cantidad-o}getFirstDayOfMonth(){return new Date(this.today.getFullYear(),this.today.getMonth(),1).toJSON().split("T")[0]}onSave(t){var o=this;return(0,f.A)(function*(){yield(yield o.actionSheetCtrl.create({header:"\xbfDesea guardar el recibo?",buttons:[{text:"Aceptar",role:"confirm",icon:"checkmark",handler:()=>{o.save(t)}},{text:"Cancelar",role:"cancel",icon:"close"}]})).present()})()}save(t){t.casa=t.casa.ID,this.fillEvent(t),this.service.save(this.item,this.itemDetail).subscribe({next:n=>{if(this.sendEmail){let l=new Date(t.fecha),m=new Date(l.getTime()+6e4*this.date.getTimezoneOffset());t.fecha=m.toLocaleDateString(),this.service.sendEmail(t,t.conceptos).subscribe({next:u=>{this.meesageToast("correo enviado")},error:u=>{console.log("Error email: ",u)}})}this.meesageToast("Se guardo exitosamente"),this.loadingUtil.dismiss(),this.itemDetail=this.convertMonth(this.itemDetail),this.confirm(this.itemDetail)},error:n=>{this.meesageToast("No se pudo guardar el dato"),this.loadingUtil.dismiss()}}),this.loadingUtil.showing(),t.sendEmail=!0}convertMonth(t){return t.map(o=>{var n;const[l,m,u]=(null===(n=o.MES)||void 0===n?void 0:n.split("-"))||[],b=`${l}-${m}-${u}T06:00:00.000Z`;return{...o,MES:b}})}fillEvent(t){this.item.FOLIO=t.folio,new Date(t.fecha),this.item.FECHA=t.fecha,this.item.CASA=t.casa,this.item.NOMBRE=t.nombre,this.item.CORREO=t.email,this.item.CANTIDAD=t.cantidad;var n=t.conceptos;this.itemDetail=[],n&&(this.item.CONCEPTO=t.conceptos[0].concepto,n.forEach(l=>{var m={};m.FOLIO=t.folio,m.CASA=t.casa,m.NOMBRE=t.nombre,m.CONCEPTO=l.concepto,m.MES=l.mes,m.MONTO=l.monto,this.itemDetail.push(m)}))}removeInputField(t){this.fields.controls.conceptos.removeAt(t)}addNewInputField(){this.fields.controls.conceptos.push(this.frmConceptos())}meesageToast(t){this.toastUtil.presentToast(t,"top")}confirm(t){this.modalCtrl.dismiss(t,"confirm")}close(){this.modalCtrl.dismiss(null,"cancel")}}return(a=h).\u0275fac=function(t){return new(t||a)(e.rXU(s.W3),e.rXU(s.GD),e.rXU(i.ok),e.rXU(_.f),e.rXU(g.L),e.rXU(C.w),e.rXU(d.l))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-add-recibos"]],standalone:!1,decls:33,vars:4,consts:[["slot","start"],[3,"click"],["name","close"],[1,"ion-padding"],[3,"ngSubmit","formGroup"],["label","Folio","labelPlacement","floating","id","folio","type","number","formControlName","folio"],["label","Fecha","labelPlacement","floating","id","fecha","type","date","formControlName","fecha"],["label","Casa","labelPlacement","floating","id","casa","interface","popover","formControlName","casa",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["label","Nombre","labelPlacement","floating","id","nombre","type","text","formControlName","nombre"],["label","Email","labelPlacement","floating","id","email","type","email","formControlName","email"],["id","sendEmail","item-right","","secondary","","formControlName","sendEmail","color","green"],["label","Cantidad","labelPlacement","floating","id","cantidad","type","number","formControlName","cantidad"],["slot","start","name","cash","aria-hidden","true"],["formArrayName","conceptos","margin-bottom",""],[3,"formGroupName",4,"ngFor","ngForOf"],["size","small","fill","clear","color","primary",3,"click"],["slot","start","name","add"],["type","submit","expand","block",3,"disabled"],[3,"value"],[3,"formGroupName"],["color","light"],["label","Concepto:","labelPlacement","floating","interface","popover","id","concepto","formControlName","concepto",3,"ionChange"],["floating",""],["id","mes","displayFormat","MMM. YYYY","formControlName","mes","monthShortNames","Ene, Feb, Mar, Apr, May, Jun, Jul, Ago, Sep, Oct, Nov, Dic","presentation","month-year",3,"preferWheel"],["label","Monto:","labelPlacement","floating","id","monto","type","number","maxlength","50","formControlName","monto"],["size","small","fill","clear","color","danger",3,"click",4,"ngIf"],["size","small","fill","clear","color","danger",3,"click"]],template:function(t,o){1&t&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Agregar Recibos"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return o.close()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"form",4),e.bIt("ngSubmit",function(){return o.onSave(o.fields.value)}),e.j41(9,"ion-item"),e.nrm(10,"ion-input",5),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",6),e.k0s(),e.j41(13,"ion-item")(14,"ion-select",7),e.bIt("ionChange",function(l){return o.onChangeCasa(l)}),e.DNE(15,O,2,3,"ion-select-option",8),e.nrm(16,"ion-select-option")(17,"ion-select-option"),e.k0s()(),e.j41(18,"ion-item"),e.nrm(19,"ion-input",9),e.k0s(),e.j41(20,"ion-item"),e.nrm(21,"ion-input",10)(22,"ion-checkbox",11),e.k0s(),e.j41(23,"ion-item")(24,"ion-input",12),e.nrm(25,"ion-icon",13),e.k0s()(),e.j41(26,"div",14),e.DNE(27,A,14,5,"section",15),e.k0s(),e.j41(28,"ion-button",16),e.bIt("click",function(){return o.addNewInputField()}),e.nrm(29,"ion-icon",17),e.EFF(30," nuevo concepto "),e.k0s(),e.j41(31,"ion-button",18),e.EFF(32,"Agregar"),e.k0s()()()),2&t&&(e.R7$(8),e.Y8G("formGroup",o.fields),e.R7$(7),e.Y8G("ngForOf",o.casas),e.R7$(12),e.Y8G("ngForOf",o.conceptoForm.controls),e.R7$(4),e.Y8G("disabled",!o.fields.valid))},dependencies:[p.Sq,p.bT,i.qT,i.BC,i.cb,i.tU,s.Jm,s.QW,s.eY,s.W9,s.A9,s.eU,s.iq,s.$w,s.uz,s.Dg,s.jh,s.he,s.Nm,s.Ip,s.BC,s.ai,s.hB,s.su,s.Je,s.Gw,i.j4,i.JD,i.$R,i.v8],styles:["ion-select[_ngcontent-%COMP%]{min-width:100%;padding-left:0}"]}),h})()},7578:(v,E,c)=>{c.d(E,{l:()=>s});var f=c(467),i=c(4438),e=c(4742);let s=(()=>{var _;class g{constructor(d){this.alertCtrl=d}showSucess(d){var p=this;return(0,f.A)(function*(){yield(yield p.alertCtrl.create({header:"Exito",message:d,buttons:["OK"]})).present(),console.log("Success:",d)})()}showError(d){var p=this;return(0,f.A)(function*(){yield(yield p.alertCtrl.create({header:"Error",message:d,buttons:["OK"]})).present(),console.error("Error:",d)})()}}return(_=g).\u0275fac=function(d){return new(d||_)(i.KVO(e.hG))},_.\u0275prov=i.jDH({token:_,factory:_.\u0275fac,providedIn:"root"}),g})()}}]);