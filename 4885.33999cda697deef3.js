"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4885],{4885:(F,O,m)=>{m.d(O,{c:()=>P});var g=m(467),s=m(4341),e=m(4438),r=m(4742),_=m(4735),v=m(7568),b=m(3511),h=m(7578),E=m(177);function R(a,d){if(1&a&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&a){const l=d.$implicit;e.Y8G("value",l),e.R7$(),e.SpI(" ",l.NOMBRE," ")}}function I(a,d){if(1&a){const l=e.RV6();e.j41(0,"ion-item")(1,"ion-select",20),e.bIt("ionChange",function(o){e.eBV(l);const i=e.XpG();return e.Njj(i.onChangePrefijo(o))}),e.DNE(2,R,2,2,"ion-select-option",9),e.k0s()()}if(2&a){const l=e.XpG();e.R7$(2),e.Y8G("ngForOf",l.prefijos)}}function M(a,d){if(1&a&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&a){const l=d.$implicit;e.Y8G("value",l),e.R7$(),e.Lme("",l.ID,"--",l.NOMBRE," ")}}function j(a,d){if(1&a&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&a){const l=d.$implicit;e.Y8G("value",l.NOMBRE),e.R7$(),e.SpI(" ",l.NOMBRE," ")}}function A(a,d){if(1&a){const l=e.RV6();e.j41(0,"ion-button",29),e.bIt("click",function(){e.eBV(l);const o=e.XpG().index,i=e.XpG();return e.Njj(i.removeInputField(o))}),e.nrm(1,"ion-icon",2),e.EFF(2," eliminar "),e.k0s()}}function N(a,d){if(1&a){const l=e.RV6();e.j41(0,"section",22)(1,"ion-item-group")(2,"ion-item-divider",23),e.EFF(3),e.k0s(),e.j41(4,"ion-item")(5,"ion-select",24),e.bIt("ionChange",function(o){const i=e.eBV(l).index,n=e.XpG();return e.Njj(n.onChangeConcepto(o,i))}),e.DNE(6,j,2,2,"ion-select-option",9),e.k0s()(),e.j41(7,"ion-item")(8,"ion-label",25),e.EFF(9,"Mes:"),e.k0s(),e.nrm(10,"ion-datetime",26),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",27),e.k0s(),e.DNE(13,A,3,0,"ion-button",28),e.k0s()()}if(2&a){const l=d.index,t=e.XpG();e.Y8G("formGroupName",l),e.R7$(3),e.SpI("Conceptos #",l+1,""),e.R7$(3),e.Y8G("ngForOf",t.conceptos),e.R7$(4),e.Y8G("preferWheel",!0),e.R7$(3),e.Y8G("ngIf",t.conceptoForm.length>1)}}let P=(()=>{var a;class d{constructor(t,o,i,n,c,f,p){this.modalCtrl=t,this.actionSheetCtrl=o,this.formBuilder=i,this.service=n,this.loadingUtil=c,this.toastUtil=f,this.alertUtil=p,this.user=null,this.item={FOLIO:0,CASA:"",NOMBRE:"",CANTIDAD:"",CONCEPTO:"",FECHA:"",CORREO:"",INPUT_TIMESTAMP:"",PREFIX:""},this.itemDetail=[],this.itemDetailConfirms=[],this.casas=[],this.conceptos=[],this.prefijos=[],this.data=!1,this.sendEmail=!1,this.date=new Date,this.today=new Date(this.date.getTime()-6e4*this.date.getTimezoneOffset()),this.fields=this.formBuilder.group({prefijo:["",s.k0.required],folio:["",s.k0.required],casa:["",s.k0.required],nombre:["",s.k0.required],fecha:["",s.k0.required],email:["",s.k0.required],sendEmail:"",cantidad:["",s.k0.required],conceptos:this.formBuilder.array([this.frmConceptos()])})}frmConceptos(){return this.formBuilder.group({concepto:["",[s.k0.required,s.k0.minLength(3)]],mes:["",[s.k0.required]],monto:["",[s.k0.required,s.k0.min(0),s.k0.pattern(/^\d+(\.\d{1,2})?$/)]]})}get conceptoForm(){return this.fields.get("conceptos")}ngOnInit(){this.service.getSpreadSheetId().then(()=>{const t=this.today.toJSON().split("T")[0];this.fields.patchValue({fecha:t}),this.inittial()}),this.loadingUtil.showing()}getMaxFolio(){this.service.getFullDataDetail().subscribe({next:t=>{const o=Math.max(...t.map(i=>i.FOLIO))+1;this.fields.patchValue({folio:o}),this.loadingUtil.dismiss()},error:t=>{this.fields.patchValue({folio:1}),this.loadingUtil.dismiss(),this.alertUtil.showError("No se pudo obtener el folio: "+t.message)}})}inittial(){var t=this;const o=localStorage.getItem("user");var i;this.user=o?JSON.parse(o):null,this.service.getFullData().subscribe({next:i=>{this.casas=i||[],this.service.getConceptos().subscribe(n=>{this.conceptos=n||[]}),this.service.getPrefijos().subscribe(n=>{this.prefijos=n||[],this.calPrefijoUser(),this.loadingUtil.dismiss()})},error:(i=(0,g.A)(function*(n){console.error("Error al cargar datos:",n),t.loadingUtil.dismiss(),t.alertUtil.showError("No se pudieron cargar los datos: "+n.message)}),function(c){return i.apply(this,arguments)})})}onChangeCasa(t){const o=t.detail.value;o.ID&&(this.casa=this.casas.find(i=>i.ID===o.ID&&i.NOMBRE===o.NOMBRE?i:null),this.fields.patchValue({nombre:this.casa.NOMBRE,email:this.casa.EMAIL,sendEmail:!0}))}onChangePrefijo(t){var o;const i=t.detail.value;if(!i)return;let n=this.prefijos.find(c=>c.NOMBRE===i.NOMBRE);this.fields.patchValue({folio:(null!==(o=null==n?void 0:n.FOLIO)&&void 0!==o?o:0)+1})}onChangeConcepto(t,o){if(t.detail.value){const n=this.fields.controls.conceptos;let c=this.calMontoConcepto();n.at(o).patchValue({mes:this.getFirstDayOfMonth(),monto:c})}}calMontoConcepto(){let o=0;return this.fields.controls.conceptos.controls.forEach(i=>{o+=i.value.monto}),this.fields.value.cantidad-o}getFirstDayOfMonth(){return new Date(this.today.getFullYear(),this.today.getMonth(),1).toJSON().split("T")[0]}onSave(t){var o=this;return(0,g.A)(function*(){yield(yield o.actionSheetCtrl.create({header:"\xbfDesea guardar el recibo?",buttons:[{text:"Guardar",role:"confirm",icon:"checkmark",handler:()=>{o.save(t)}},{text:"Cancelar",role:"cancel",icon:"close"}]})).present()})()}save(t){var o,i;t.casa=t.casa.ID;let c=t.folio,f=null!==(o=null===(i=t.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==o?o:"";this.fillEvent(t),this.service.save(this.item,this.itemDetail).subscribe({next:p=>{if(this.sendEmail){let C=new Date(t.fecha),u=new Date(C.getTime()+6e4*this.date.getTimezoneOffset());t.fecha=u.toLocaleDateString(),this.service.sendEmail(t,t.conceptos).subscribe({next:D=>{this.meesageToast("correo enviado")},error:D=>{console.log("Error email: ",D)}})}this.meesageToast("Se guardo exitosamente"),this.loadingUtil.dismiss(),this.itemDetail=this.convertMonth(this.itemDetail),this.calSavePrefijos(c,f),this.otherSave(this.itemDetail)},error:p=>{this.meesageToast("No se pudo guardar el dato"),this.loadingUtil.dismiss()}}),this.loadingUtil.showing(),t.sendEmail=!0}otherSave(t){var o=this;return(0,g.A)(function*(){yield(yield o.actionSheetCtrl.create({header:"\xbfDesea agregar otro recibo ?",buttons:[{text:"Otro recibo",role:"other",icon:"add",handler:()=>{o.fields.reset();const n=o.today.toJSON().split("T")[0];o.fields.patchValue({fecha:n}),o.calPrefijoUser(),o.itemDetailConfirms.push(...t)}},{text:"Salir",role:"confirm",icon:"checkmark",handler:()=>{o.itemDetailConfirms.push(...t),console.log(o.itemDetailConfirms),o.confirm(o.itemDetailConfirms)}}]})).present()})()}convertMonth(t){return t.map(o=>{var i;const[n,c,f]=(null===(i=o.MES)||void 0===i?void 0:i.split("-"))||[],p=`${n}-${c}-${f}T06:00:00.000Z`;return{...o,MES:p}})}calPrefijoUser(){let t=this.prefijos.find(o=>{var i,n,c;return(null===(i=o.NOMBRE)||void 0===i?void 0:i.toUpperCase())===(null===(n=this.user)||void 0===n||null===(n=n.ID)||void 0===n?void 0:n.toUpperCase())&&"user"===(null===(c=this.user)||void 0===c?void 0:c.ROLE)});t&&this.fields.patchValue({prefijo:t.NOMBRE,folio:(null==t?void 0:t.FOLIO)+1})}calSavePrefijos(t,o){if(!o)return;let i=this.prefijos.find(n=>n.PREFIX===o);i&&(i.FOLIO=t)}fillEvent(t){var o,i;this.item.FOLIO=t.folio,new Date(t.fecha),this.item.FECHA=t.fecha,this.item.CASA=t.casa,this.item.NOMBRE=t.nombre,this.item.CORREO=t.email,this.item.CANTIDAD=t.cantidad,this.item.PREFIX=null!==(o=null===(i=t.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==o?o:"";var c=t.conceptos;this.itemDetail=[],c&&(this.item.CONCEPTO=t.conceptos[0].concepto,c.forEach(f=>{var p,C,u={};u.FOLIO=t.folio,u.CASA=t.casa,u.NOMBRE=t.nombre,u.CONCEPTO=f.concepto,u.MES=f.mes,u.MONTO=f.monto,u.PREFIX=null!==(p=null===(C=t.prefijo)||void 0===C?void 0:C.PREFIX)&&void 0!==p?p:"",this.itemDetail.push(u)}))}removeInputField(t){this.fields.controls.conceptos.removeAt(t)}addNewInputField(){this.fields.controls.conceptos.push(this.frmConceptos())}meesageToast(t){this.toastUtil.presentToast(t,"top")}confirm(t){this.modalCtrl.dismiss(t,"confirm")}close(){this.modalCtrl.dismiss(null,"cancel")}}return(a=d).\u0275fac=function(t){return new(t||a)(e.rXU(r.W3),e.rXU(r.GD),e.rXU(s.ok),e.rXU(_.f),e.rXU(v.L),e.rXU(b.w),e.rXU(h.l))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-add-recibos"]],standalone:!1,decls:34,vars:5,consts:[["slot","start"],[3,"click"],["name","close"],[1,"ion-padding"],[3,"ngSubmit","formGroup"],[4,"ngIf"],["label","Folio","labelPlacement","floating","id","folio","type","number","formControlName","folio"],["label","Fecha","labelPlacement","floating","id","fecha","type","date","formControlName","fecha"],["label","Casa","labelPlacement","floating","id","casa","interface","popover","formControlName","casa",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["label","Nombre","labelPlacement","floating","id","nombre","type","text","formControlName","nombre"],["label","Email","labelPlacement","floating","id","email","type","email","formControlName","email"],["id","sendEmail","item-right","","secondary","","formControlName","sendEmail","color","green"],["label","Cantidad","labelPlacement","floating","id","cantidad","type","number","formControlName","cantidad"],["slot","start","name","cash","aria-hidden","true"],["formArrayName","conceptos","margin-bottom",""],[3,"formGroupName",4,"ngFor","ngForOf"],["size","small","fill","clear","color","primary",3,"click"],["slot","start","name","add"],["type","submit","expand","block",3,"disabled"],["label","Prefix:","labelPlacement","floating","interface","popover","id","prefijo","formControlName","prefijo",3,"ionChange"],[3,"value"],[3,"formGroupName"],["color","light"],["label","Concepto:","labelPlacement","floating","interface","popover","id","concepto","formControlName","concepto",3,"ionChange"],["floating",""],["id","mes","displayFormat","MMM. YYYY","formControlName","mes","monthShortNames","Ene, Feb, Mar, Apr, May, Jun, Jul, Ago, Sep, Oct, Nov, Dic","presentation","month-year",3,"preferWheel"],["label","Monto:","labelPlacement","floating","id","monto","type","number","maxlength","50","formControlName","monto"],["size","small","fill","clear","color","danger",3,"click",4,"ngIf"],["size","small","fill","clear","color","danger",3,"click"]],template:function(t,o){1&t&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Agregar Recibos"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return o.close()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"form",4),e.bIt("ngSubmit",function(){return o.onSave(o.fields.value)}),e.DNE(9,I,3,1,"ion-item",5),e.j41(10,"ion-item"),e.nrm(11,"ion-input",6),e.k0s(),e.j41(12,"ion-item"),e.nrm(13,"ion-input",7),e.k0s(),e.j41(14,"ion-item")(15,"ion-select",8),e.bIt("ionChange",function(n){return o.onChangeCasa(n)}),e.DNE(16,M,2,3,"ion-select-option",9),e.nrm(17,"ion-select-option")(18,"ion-select-option"),e.k0s()(),e.j41(19,"ion-item"),e.nrm(20,"ion-input",10),e.k0s(),e.j41(21,"ion-item"),e.nrm(22,"ion-input",11)(23,"ion-checkbox",12),e.k0s(),e.j41(24,"ion-item")(25,"ion-input",13),e.nrm(26,"ion-icon",14),e.k0s()(),e.j41(27,"div",15),e.DNE(28,N,14,5,"section",16),e.k0s(),e.j41(29,"ion-button",17),e.bIt("click",function(){return o.addNewInputField()}),e.nrm(30,"ion-icon",18),e.EFF(31," nuevo concepto "),e.k0s(),e.j41(32,"ion-button",19),e.EFF(33,"Agregar"),e.k0s()()()),2&t&&(e.R7$(8),e.Y8G("formGroup",o.fields),e.R7$(),e.Y8G("ngIf","admin"===(null==o.user?null:o.user.ROLE)||"dev"===(null==o.user?null:o.user.ROLE)||"manager"===(null==o.user?null:o.user.ROLE)),e.R7$(7),e.Y8G("ngForOf",o.casas),e.R7$(12),e.Y8G("ngForOf",o.conceptoForm.controls),e.R7$(4),e.Y8G("disabled",!o.fields.valid))},dependencies:[E.Sq,E.bT,s.qT,s.BC,s.cb,s.tU,r.Jm,r.QW,r.eY,r.W9,r.A9,r.eU,r.iq,r.$w,r.uz,r.Dg,r.jh,r.he,r.Nm,r.Ip,r.BC,r.ai,r.hB,r.su,r.Je,r.Gw,s.j4,s.JD,s.$R,s.v8],styles:["ion-select[_ngcontent-%COMP%]{min-width:100%;padding-left:0}"]}),d})()},7578:(F,O,m)=>{m.d(O,{l:()=>r});var g=m(467),s=m(4438),e=m(4742);let r=(()=>{var _;class v{constructor(h){this.alertCtrl=h}showSucess(h){var E=this;return(0,g.A)(function*(){yield(yield E.alertCtrl.create({header:"Exito",message:h,buttons:["OK"]})).present(),console.log("Success:",h)})()}showError(h){var E=this;return(0,g.A)(function*(){yield(yield E.alertCtrl.create({header:"Error",message:h,buttons:["OK"]})).present(),console.error("Error:",h)})()}}return(_=v).\u0275fac=function(h){return new(h||_)(s.KVO(e.hG))},_.\u0275prov=s.jDH({token:_,factory:_.\u0275fac,providedIn:"root"}),v})()}}]);