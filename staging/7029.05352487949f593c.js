"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7029],{4885:(b,v,m)=>{m.d(v,{c:()=>R});var C,h=m(9204),n=m(496),e=m(7404),a=m(9618),g=m(4735),f=m(7568),r=m(3511),c=m(7578),O=m(316);function D(d,o){if(1&d&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&d){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.SpI(" ",t.NOMBRE," ")}}function I(d,o){if(1&d){const t=e.RV6();e.j41(0,"ion-item")(1,"ion-select",20),e.bIt("ionChange",function(s){e.eBV(t);const l=e.XpG();return e.Njj(l.onChangePrefijo(s))}),e.DNE(2,D,2,2,"ion-select-option",9),e.k0s()()}if(2&d){const t=e.XpG();e.R7$(2),e.Y8G("ngForOf",t.prefijos)}}function P(d,o){if(1&d&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&d){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.Lme("",t.ID,"--",t.NOMBRE," ")}}function F(d,o){if(1&d&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&d){const t=o.$implicit;e.Y8G("value",t.NOMBRE),e.R7$(),e.SpI(" ",t.NOMBRE," ")}}function N(d,o){if(1&d){const t=e.RV6();e.j41(0,"ion-button",29),e.bIt("click",function(){e.eBV(t);const s=e.XpG().index,l=e.XpG();return e.Njj(l.removeInputField(s))}),e.nrm(1,"ion-icon",2),e.EFF(2," eliminar "),e.k0s()}}function A(d,o){if(1&d){const t=e.RV6();e.j41(0,"section",22)(1,"ion-item-group")(2,"ion-item-divider",23),e.EFF(3),e.k0s(),e.j41(4,"ion-item")(5,"ion-select",24),e.bIt("ionChange",function(s){const l=e.eBV(t).index,p=e.XpG();return e.Njj(p.onChangeConcepto(s,l))}),e.DNE(6,F,2,2,"ion-select-option",9),e.k0s()(),e.j41(7,"ion-item")(8,"ion-label",25),e.EFF(9,"Mes:"),e.k0s(),e.nrm(10,"ion-datetime",26),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",27),e.k0s(),e.DNE(13,N,3,0,"ion-button",28),e.k0s()()}if(2&d){const t=o.index,i=e.XpG();e.Y8G("formGroupName",t),e.R7$(3),e.SpI("Conceptos #",t+1,""),e.R7$(3),e.Y8G("ngForOf",i.conceptos),e.R7$(4),e.Y8G("preferWheel",!0),e.R7$(3),e.Y8G("ngIf",i.conceptoForm.length>1)}}class R{constructor(o,t,i,s,l,p,_){this.modalCtrl=o,this.actionSheetCtrl=t,this.formBuilder=i,this.service=s,this.loadingUtil=l,this.toastUtil=p,this.alertUtil=_,this.user=null,this.item={FOLIO:0,CASA:"",NOMBRE:"",CANTIDAD:"",CONCEPTO:"",FECHA:"",CORREO:"",INPUT_TIMESTAMP:"",PREFIX:""},this.itemDetail=[],this.itemDetailConfirms=[],this.casas=[],this.conceptos=[],this.prefijos=[],this.data=!1,this.sendEmail=!1,this.date=new Date,this.today=new Date(this.date.getTime()-6e4*this.date.getTimezoneOffset()),this.fields=this.formBuilder.group({prefijo:["",n.k0.required],folio:["",n.k0.required],casa:["",n.k0.required],nombre:["",n.k0.required],fecha:["",n.k0.required],email:["",n.k0.required],sendEmail:"",cantidad:["",n.k0.required],conceptos:this.formBuilder.array([this.frmConceptos()])})}frmConceptos(){return this.formBuilder.group({concepto:["",[n.k0.required,n.k0.minLength(3)]],mes:["",[n.k0.required]],monto:["",[n.k0.required,n.k0.min(0),n.k0.pattern(/^\d+(\.\d{1,2})?$/)]]})}get conceptoForm(){return this.fields.get("conceptos")}ngOnInit(){this.service.getSpreadSheetId().then(()=>{const o=this.today.toJSON().split("T")[0];this.fields.patchValue({fecha:o}),this.inittial()}),this.loadingUtil.showing()}getMaxFolio(){this.service.getFullDataDetail().subscribe({next:o=>{const t=Math.max(...o.map(i=>i.FOLIO))+1;this.fields.patchValue({folio:t}),this.loadingUtil.dismiss()},error:o=>{this.fields.patchValue({folio:1}),this.loadingUtil.dismiss(),this.alertUtil.showError("No se pudo obtener el folio: "+o.message)}})}inittial(){var o=this;const t=localStorage.getItem("user");var i;this.user=t?JSON.parse(t):null,this.service.getFullData().subscribe({next:i=>{this.casas=i||[],this.service.getConceptos().subscribe(s=>{this.conceptos=s||[]}),this.service.getPrefijos().subscribe(s=>{this.prefijos=s||[],this.calPrefijoUser(),this.loadingUtil.dismiss()})},error:(i=(0,h.A)(function*(s){console.error("Error al cargar datos:",s),o.loadingUtil.dismiss(),o.alertUtil.showError("No se pudieron cargar los datos: "+s.message)}),function(l){return i.apply(this,arguments)})})}onChangeCasa(o){const t=o.detail.value;t.ID&&(this.casa=this.casas.find(i=>i.ID===t.ID&&i.NOMBRE===t.NOMBRE?i:null),this.fields.patchValue({nombre:this.casa.NOMBRE,email:this.casa.EMAIL,sendEmail:!0}))}onChangePrefijo(o){var t;const i=o.detail.value;if(!i)return;let s=this.prefijos.find(l=>l.NOMBRE===i.NOMBRE);this.fields.patchValue({folio:(null!==(t=null==s?void 0:s.FOLIO)&&void 0!==t?t:0)+1})}onChangeConcepto(o,t){if(o.detail.value){const s=this.fields.controls.conceptos;let l=this.calMontoConcepto();s.at(t).patchValue({mes:this.getFirstDayOfMonth(),monto:l})}}calMontoConcepto(){const o=this.fields.controls.conceptos;let t=0;return o.controls.forEach(i=>{t+=i.value.monto}),this.fields.value.cantidad-t}getFirstDayOfMonth(){return new Date(this.today.getFullYear(),this.today.getMonth(),1).toJSON().split("T")[0]}onSave(o){var t=this;return(0,h.A)(function*(){yield(yield t.actionSheetCtrl.create({header:"\xbfDesea guardar el recibo?",buttons:[{text:"Guardar",role:"confirm",icon:"checkmark",handler:()=>{t.save(o)}},{text:"Cancelar",role:"cancel",icon:"close"}]})).present()})()}save(o){var t,i;let s=o.casa;o.casa=s.ID;let l=o.folio,p=null!==(t=null===(i=o.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==t?t:"";this.fillEvent(o),this.service.save(this.item,this.itemDetail).subscribe({next:_=>{if(this.sendEmail){let E=new Date(o.fecha),u=new Date(E.getTime()+6e4*this.date.getTimezoneOffset());o.fecha=u.toLocaleDateString(),this.service.sendEmail(o,o.conceptos).subscribe({next:M=>{this.meesageToast("correo enviado")},error:M=>{console.log("Error email: ",M)}})}this.meesageToast("Se guardo exitosamente"),this.loadingUtil.dismiss(),this.itemDetail=this.convertMonth(this.itemDetail),this.calSavePrefijos(l,p),this.otherSave(this.itemDetail)},error:_=>{this.meesageToast("No se pudo guardar el dato"),this.loadingUtil.dismiss()}}),this.loadingUtil.showing(),o.sendEmail=!0}otherSave(o){var t=this;return(0,h.A)(function*(){yield(yield t.actionSheetCtrl.create({header:"\xbfDesea agregar otro recibo ?",buttons:[{text:"Otro recibo",role:"other",icon:"add",handler:()=>{t.fields.reset();const s=t.today.toJSON().split("T")[0];t.fields.patchValue({fecha:s}),t.calPrefijoUser(),t.itemDetailConfirms.push(...o)}},{text:"Salir",role:"confirm",icon:"checkmark",handler:()=>{t.itemDetailConfirms.push(...o),console.log(t.itemDetailConfirms),t.confirm(t.itemDetailConfirms)}}]})).present()})()}convertMonth(o){return o.map(t=>{var i;const[s,l,p]=(null===(i=t.MES)||void 0===i?void 0:i.split("-"))||[],_=`${s}-${l}-${p}T06:00:00.000Z`;return{...t,MES:_}})}calPrefijoUser(){let o=this.prefijos.find(t=>{var i,s,l;return(null===(i=t.NOMBRE)||void 0===i?void 0:i.toUpperCase())===(null===(s=this.user)||void 0===s||null===(s=s.ID)||void 0===s?void 0:s.toUpperCase())&&"user"===(null===(l=this.user)||void 0===l?void 0:l.ROLE)});o&&this.fields.patchValue({prefijo:o,folio:(null==o?void 0:o.FOLIO)+1})}calSavePrefijos(o,t){if(!t)return;let i=this.prefijos.find(s=>s.PREFIX===t);i&&(i.FOLIO=o)}fillEvent(o){var t,i;this.item.FOLIO=o.folio;new Date(o.fecha);this.item.FECHA=o.fecha,this.item.CASA=o.casa,this.item.NOMBRE=o.nombre,this.item.CORREO=o.email,this.item.CANTIDAD=o.cantidad,this.item.PREFIX=null!==(t=null===(i=o.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==t?t:"";var l=o.conceptos;this.itemDetail=[],l&&(this.item.CONCEPTO=o.conceptos[0].concepto,l.forEach(p=>{var _,E,u={};u.FOLIO=o.folio,u.CASA=o.casa,u.NOMBRE=o.nombre,u.CONCEPTO=p.concepto,u.MES=p.mes,u.MONTO=p.monto,u.PREFIX=null!==(_=null===(E=o.prefijo)||void 0===E?void 0:E.PREFIX)&&void 0!==_?_:"",this.itemDetail.push(u)}))}removeInputField(o){this.fields.controls.conceptos.removeAt(o)}addNewInputField(){this.fields.controls.conceptos.push(this.frmConceptos())}meesageToast(o){this.toastUtil.presentToast(o,"top")}confirm(o){this.modalCtrl.dismiss(o,"confirm")}close(){this.modalCtrl.dismiss(null,"cancel")}}(C=R).\u0275fac=function(o){return new(o||C)(e.rXU(a.W3),e.rXU(a.GD),e.rXU(n.ok),e.rXU(g.f),e.rXU(f.L),e.rXU(r.w),e.rXU(c.l))},C.\u0275cmp=e.VBU({type:C,selectors:[["app-add-recibos"]],standalone:!1,decls:34,vars:5,consts:[["slot","start"],[3,"click"],["name","close"],[1,"ion-padding"],[3,"ngSubmit","formGroup"],[4,"ngIf"],["label","Folio","labelPlacement","floating","id","folio","type","number","formControlName","folio"],["label","Fecha","labelPlacement","floating","id","fecha","type","date","formControlName","fecha"],["label","Casa","labelPlacement","floating","id","casa","interface","popover","formControlName","casa",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["label","Nombre","labelPlacement","floating","id","nombre","type","text","formControlName","nombre"],["label","Email","labelPlacement","floating","id","email","type","email","formControlName","email"],["id","sendEmail","item-right","","secondary","","formControlName","sendEmail","color","green"],["label","Cantidad","labelPlacement","floating","id","cantidad","type","number","formControlName","cantidad"],["slot","start","name","cash","aria-hidden","true"],["formArrayName","conceptos","margin-bottom",""],[3,"formGroupName",4,"ngFor","ngForOf"],["size","small","fill","clear","color","primary",3,"click"],["slot","start","name","add"],["type","submit","expand","block",3,"disabled"],["label","Prefix:","labelPlacement","floating","interface","popover","id","prefijo","formControlName","prefijo",3,"ionChange"],[3,"value"],[3,"formGroupName"],["color","light"],["label","Concepto:","labelPlacement","floating","interface","popover","id","concepto","formControlName","concepto",3,"ionChange"],["floating",""],["id","mes","displayFormat","MMM. YYYY","formControlName","mes","monthShortNames","Ene, Feb, Mar, Apr, May, Jun, Jul, Ago, Sep, Oct, Nov, Dic","presentation","month-year",3,"preferWheel"],["label","Monto:","labelPlacement","floating","id","monto","type","number","maxlength","50","formControlName","monto"],["size","small","fill","clear","color","danger",3,"click",4,"ngIf"],["size","small","fill","clear","color","danger",3,"click"]],template:function(o,t){1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Agregar Recibos"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return t.close()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"form",4),e.bIt("ngSubmit",function(){return t.onSave(t.fields.value)}),e.DNE(9,I,3,1,"ion-item",5),e.j41(10,"ion-item"),e.nrm(11,"ion-input",6),e.k0s(),e.j41(12,"ion-item"),e.nrm(13,"ion-input",7),e.k0s(),e.j41(14,"ion-item")(15,"ion-select",8),e.bIt("ionChange",function(s){return t.onChangeCasa(s)}),e.DNE(16,P,2,3,"ion-select-option",9),e.nrm(17,"ion-select-option")(18,"ion-select-option"),e.k0s()(),e.j41(19,"ion-item"),e.nrm(20,"ion-input",10),e.k0s(),e.j41(21,"ion-item"),e.nrm(22,"ion-input",11)(23,"ion-checkbox",12),e.k0s(),e.j41(24,"ion-item")(25,"ion-input",13),e.nrm(26,"ion-icon",14),e.k0s()(),e.j41(27,"div",15),e.DNE(28,A,14,5,"section",16),e.k0s(),e.j41(29,"ion-button",17),e.bIt("click",function(){return t.addNewInputField()}),e.nrm(30,"ion-icon",18),e.EFF(31," nuevo concepto "),e.k0s(),e.j41(32,"ion-button",19),e.EFF(33,"Agregar"),e.k0s()()()),2&o&&(e.R7$(8),e.Y8G("formGroup",t.fields),e.R7$(),e.Y8G("ngIf","admin"===(null==t.user?null:t.user.ROLE)||"dev"===(null==t.user?null:t.user.ROLE)||"manager"===(null==t.user?null:t.user.ROLE)),e.R7$(7),e.Y8G("ngForOf",t.casas),e.R7$(12),e.Y8G("ngForOf",t.conceptoForm.controls),e.R7$(4),e.Y8G("disabled",!t.fields.valid))},dependencies:[O.Sq,O.bT,n.qT,n.BC,n.cb,n.tU,a.Jm,a.QW,a.eY,a.W9,a.A9,a.eU,a.iq,a.$w,a.uz,a.Dg,a.jh,a.he,a.Nm,a.Ip,a.BC,a.ai,a.hB,a.su,a.Je,a.Gw,n.j4,n.JD,n.$R,n.v8],styles:["ion-select[_ngcontent-%COMP%]{min-width:100%;padding-left:0}\n\n/*# sourceMappingURL=add-recibos.component.css.map*/"]})},5441:(b,v,m)=>{m.d(v,{a:()=>g});var e,h=m(316),n=m(7404);function a(f,r){if(1&f&&(n.j41(0,"div",4),n.EFF(1),n.k0s()),2&f){const c=n.XpG();n.R7$(),n.SpI(" ",c.userName," ")}}class g{constructor(){this.user=null,this.size="medium",this.initials="",this.userName=""}ngOnInit(){this.loadUserData()}ngOnChanges(){this.loadUserData()}loadUserData(){if(this.user)this.userName=this.user.NOMBRE||"",this.initials=this.getInitials(this.userName);else{const r=localStorage.getItem("user");if(r){const c=JSON.parse(r);this.userName=c.NOMBRE||"",this.initials=this.getInitials(this.userName)}else this.userName="",this.initials=""}}getInitials(r){if(!r)return"";const c=r.trim().split(" ");return 1===c.length?c[0].charAt(0).toUpperCase():(c[0].charAt(0)+c[c.length-1].charAt(0)).toUpperCase()}getSizeClass(){return`avatar-${this.size}`}}(e=g).\u0275fac=function(r){return new(r||e)},e.\u0275cmp=n.VBU({type:e,selectors:[["app-user-avatar"]],inputs:{user:"user",size:"size"},features:[n.OA$],decls:5,vars:5,consts:[[1,"user-avatar-container",3,"title","id"],[1,"user-avatar",3,"ngClass"],[1,"initials"],["class","user-tooltip",4,"ngIf"],[1,"user-tooltip"]],template:function(r,c){1&r&&(n.j41(0,"div",0)(1,"div",1)(2,"span",2),n.EFF(3),n.k0s()(),n.DNE(4,a,2,1,"div",3),n.k0s()),2&r&&(n.Y8G("title",c.userName)("id","user-avatar-"+c.size),n.R7$(),n.Y8G("ngClass",c.getSizeClass()),n.R7$(2),n.JRh(c.initials),n.R7$(),n.Y8G("ngIf",c.userName))},dependencies:[h.MD,h.YU,h.bT],styles:['@charset "UTF-8";.user-avatar-container[_ngcontent-%COMP%]{position:relative;display:inline-block;cursor:pointer}.user-avatar[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;box-shadow:0 2px 8px #00000026;transition:all .3s ease;border:2px solid rgba(255,255,255,.2)}.user-avatar[_ngcontent-%COMP%]:hover{transform:scale(1.05);box-shadow:0 4px 12px #00000040}.initials[_ngcontent-%COMP%]{font-family:Roboto,sans-serif;letter-spacing:.5px}.avatar-small[_ngcontent-%COMP%]{width:32px;height:32px;font-size:12px}.avatar-medium[_ngcontent-%COMP%]{width:40px;height:40px;font-size:14px}.avatar-large[_ngcontent-%COMP%]{width:48px;height:48px;font-size:16px}.user-tooltip[_ngcontent-%COMP%]{position:absolute;bottom:100%;left:50%;transform:translate(-50%);background:#000c;color:#fff;padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;visibility:hidden;transition:all .3s ease;z-index:1000;margin-bottom:8px;box-shadow:0 2px 8px #0003}.user-tooltip[_ngcontent-%COMP%]:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:5px solid transparent;border-top-color:#000c}.user-avatar-container[_ngcontent-%COMP%]:hover   .user-tooltip[_ngcontent-%COMP%]{opacity:1;visibility:visible}@media (max-width: 768px){.avatar-small[_ngcontent-%COMP%]{width:28px;height:28px;font-size:10px}.avatar-medium[_ngcontent-%COMP%]{width:36px;height:36px;font-size:12px}.avatar-large[_ngcontent-%COMP%]{width:44px;height:44px;font-size:14px}}']})},7578:(b,v,m)=>{m.d(v,{l:()=>g});var a,h=m(9204),n=m(7404),e=m(9618);class g{constructor(r){this.alertCtrl=r}showSucess(r){var c=this;return(0,h.A)(function*(){yield(yield c.alertCtrl.create({header:"Exito",message:r,buttons:["OK"]})).present(),console.log("Success:",r)})()}showError(r){var c=this;return(0,h.A)(function*(){yield(yield c.alertCtrl.create({header:"Error",message:r,buttons:["OK"]})).present(),console.error("Error:",r)})()}}(a=g).\u0275fac=function(r){return new(r||a)(n.KVO(e.hG))},a.\u0275prov=n.jDH({token:a,factory:a.\u0275fac,providedIn:"root"})}}]);
//# sourceMappingURL=7029.05352487949f593c.js.map