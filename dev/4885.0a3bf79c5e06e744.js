"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4885],{4885:(D,v,c)=>{c.d(v,{c:()=>b});var _,f=c(9204),r=c(496),e=c(7404),s=c(9618),E=c(4735),O=c(7568),m=c(3511),u=c(7578),C=c(316);function F(l,o){if(1&l&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&l){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.SpI(" ",t.NOMBRE," ")}}function M(l,o){if(1&l){const t=e.RV6();e.j41(0,"ion-item")(1,"ion-select",20),e.bIt("ionChange",function(n){e.eBV(t);const a=e.XpG();return e.Njj(a.onChangePrefijo(n))}),e.DNE(2,F,2,2,"ion-select-option",9),e.k0s()()}if(2&l){const t=e.XpG();e.R7$(2),e.Y8G("ngForOf",t.prefijos)}}function I(l,o){if(1&l&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&l){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.Lme("",t.ID,"--",t.NOMBRE," ")}}function j(l,o){if(1&l&&(e.j41(0,"ion-select-option",21),e.EFF(1),e.k0s()),2&l){const t=o.$implicit;e.Y8G("value",t.NOMBRE),e.R7$(),e.SpI(" ",t.NOMBRE," ")}}function N(l,o){if(1&l){const t=e.RV6();e.j41(0,"ion-button",29),e.bIt("click",function(){e.eBV(t);const n=e.XpG().index,a=e.XpG();return e.Njj(a.removeInputField(n))}),e.nrm(1,"ion-icon",2),e.EFF(2," eliminar "),e.k0s()}}function A(l,o){if(1&l){const t=e.RV6();e.j41(0,"section",22)(1,"ion-item-group")(2,"ion-item-divider",23),e.EFF(3),e.k0s(),e.j41(4,"ion-item")(5,"ion-select",24),e.bIt("ionChange",function(n){const a=e.eBV(t).index,d=e.XpG();return e.Njj(d.onChangeConcepto(n,a))}),e.DNE(6,j,2,2,"ion-select-option",9),e.k0s()(),e.j41(7,"ion-item")(8,"ion-label",25),e.EFF(9,"Mes:"),e.k0s(),e.nrm(10,"ion-datetime",26),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",27),e.k0s(),e.DNE(13,N,3,0,"ion-button",28),e.k0s()()}if(2&l){const t=o.index,i=e.XpG();e.Y8G("formGroupName",t),e.R7$(3),e.SpI("Conceptos #",t+1,""),e.R7$(3),e.Y8G("ngForOf",i.conceptos),e.R7$(4),e.Y8G("preferWheel",!0),e.R7$(3),e.Y8G("ngIf",i.conceptoForm.length>1)}}class b{constructor(o,t,i,n,a,d,p){this.modalCtrl=o,this.actionSheetCtrl=t,this.formBuilder=i,this.service=n,this.loadingUtil=a,this.toastUtil=d,this.alertUtil=p,this.user=null,this.item={FOLIO:0,CASA:"",NOMBRE:"",CANTIDAD:"",CONCEPTO:"",FECHA:"",CORREO:"",INPUT_TIMESTAMP:"",PREFIX:""},this.itemDetail=[],this.itemDetailConfirms=[],this.casas=[],this.conceptos=[],this.prefijos=[],this.data=!1,this.sendEmail=!1,this.date=new Date,this.today=new Date(this.date.getTime()-6e4*this.date.getTimezoneOffset()),this.fields=this.formBuilder.group({prefijo:["",r.k0.required],folio:["",r.k0.required],casa:["",r.k0.required],nombre:["",r.k0.required],fecha:["",r.k0.required],email:["",r.k0.required],sendEmail:"",cantidad:["",r.k0.required],conceptos:this.formBuilder.array([this.frmConceptos()])})}frmConceptos(){return this.formBuilder.group({concepto:["",[r.k0.required,r.k0.minLength(3)]],mes:["",[r.k0.required]],monto:["",[r.k0.required,r.k0.min(0),r.k0.pattern(/^\d+(\.\d{1,2})?$/)]]})}get conceptoForm(){return this.fields.get("conceptos")}ngOnInit(){this.service.getSpreadSheetId().then(()=>{const o=this.today.toJSON().split("T")[0];this.fields.patchValue({fecha:o}),this.inittial()}),this.loadingUtil.showing()}getMaxFolio(){this.service.getFullDataDetail().subscribe({next:o=>{const t=Math.max(...o.map(i=>i.FOLIO))+1;this.fields.patchValue({folio:t}),this.loadingUtil.dismiss()},error:o=>{this.fields.patchValue({folio:1}),this.loadingUtil.dismiss(),this.alertUtil.showError("No se pudo obtener el folio: "+o.message)}})}inittial(){var o=this;const t=localStorage.getItem("user");var i;this.user=t?JSON.parse(t):null,this.service.getFullData().subscribe({next:i=>{this.casas=i||[],this.service.getConceptos().subscribe(n=>{this.conceptos=n||[]}),this.service.getPrefijos().subscribe(n=>{this.prefijos=n||[],this.calPrefijoUser(),this.loadingUtil.dismiss()})},error:(i=(0,f.A)(function*(n){console.error("Error al cargar datos:",n),o.loadingUtil.dismiss(),o.alertUtil.showError("No se pudieron cargar los datos: "+n.message)}),function(a){return i.apply(this,arguments)})})}onChangeCasa(o){const t=o.detail.value;t.ID&&(this.casa=this.casas.find(i=>i.ID===t.ID&&i.NOMBRE===t.NOMBRE?i:null),this.fields.patchValue({nombre:this.casa.NOMBRE,email:this.casa.EMAIL,sendEmail:!0}))}onChangePrefijo(o){var t;const i=o.detail.value;if(!i)return;let n=this.prefijos.find(a=>a.NOMBRE===i.NOMBRE);this.fields.patchValue({folio:(null!==(t=null==n?void 0:n.FOLIO)&&void 0!==t?t:0)+1})}onChangeConcepto(o,t){if(o.detail.value){const n=this.fields.controls.conceptos;let a=this.calMontoConcepto();n.at(t).patchValue({mes:this.getFirstDayOfMonth(),monto:a})}}calMontoConcepto(){const o=this.fields.controls.conceptos;let t=0;return o.controls.forEach(i=>{t+=i.value.monto}),this.fields.value.cantidad-t}getFirstDayOfMonth(){return new Date(this.today.getFullYear(),this.today.getMonth(),1).toJSON().split("T")[0]}onSave(o){var t=this;return(0,f.A)(function*(){yield(yield t.actionSheetCtrl.create({header:"\xbfDesea guardar el recibo?",buttons:[{text:"Guardar",role:"confirm",icon:"checkmark",handler:()=>{t.save(o)}},{text:"Cancelar",role:"cancel",icon:"close"}]})).present()})()}save(o){var t,i;let n=o.casa;o.casa=n.ID;let a=o.folio,d=null!==(t=null===(i=o.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==t?t:"";this.fillEvent(o),this.service.save(this.item,this.itemDetail).subscribe({next:p=>{if(this.sendEmail){let g=new Date(o.fecha),h=new Date(g.getTime()+6e4*this.date.getTimezoneOffset());o.fecha=h.toLocaleDateString(),this.service.sendEmail(o,o.conceptos).subscribe({next:R=>{this.meesageToast("correo enviado")},error:R=>{console.log("Error email: ",R)}})}this.meesageToast("Se guardo exitosamente"),this.loadingUtil.dismiss(),this.itemDetail=this.convertMonth(this.itemDetail),this.calSavePrefijos(a,d),this.otherSave(this.itemDetail)},error:p=>{this.meesageToast("No se pudo guardar el dato"),this.loadingUtil.dismiss()}}),this.loadingUtil.showing(),o.sendEmail=!0}otherSave(o){var t=this;return(0,f.A)(function*(){yield(yield t.actionSheetCtrl.create({header:"\xbfDesea agregar otro recibo ?",buttons:[{text:"Otro recibo",role:"other",icon:"add",handler:()=>{t.fields.reset();const n=t.today.toJSON().split("T")[0];t.fields.patchValue({fecha:n}),t.calPrefijoUser(),t.itemDetailConfirms.push(...o)}},{text:"Salir",role:"confirm",icon:"checkmark",handler:()=>{t.itemDetailConfirms.push(...o),console.log(t.itemDetailConfirms),t.confirm(t.itemDetailConfirms)}}]})).present()})()}convertMonth(o){return o.map(t=>{var i;const[n,a,d]=(null===(i=t.MES)||void 0===i?void 0:i.split("-"))||[],p=`${n}-${a}-${d}T06:00:00.000Z`;return{...t,MES:p}})}calPrefijoUser(){let o=this.prefijos.find(t=>{var i,n,a;return(null===(i=t.NOMBRE)||void 0===i?void 0:i.toUpperCase())===(null===(n=this.user)||void 0===n||null===(n=n.ID)||void 0===n?void 0:n.toUpperCase())&&"user"===(null===(a=this.user)||void 0===a?void 0:a.ROLE)});o&&this.fields.patchValue({prefijo:o.NOMBRE,folio:(null==o?void 0:o.FOLIO)+1})}calSavePrefijos(o,t){if(!t)return;let i=this.prefijos.find(n=>n.PREFIX===t);i&&(i.FOLIO=o)}fillEvent(o){var t,i;this.item.FOLIO=o.folio;new Date(o.fecha);this.item.FECHA=o.fecha,this.item.CASA=o.casa,this.item.NOMBRE=o.nombre,this.item.CORREO=o.email,this.item.CANTIDAD=o.cantidad,this.item.PREFIX=null!==(t=null===(i=o.prefijo)||void 0===i?void 0:i.PREFIX)&&void 0!==t?t:"";var a=o.conceptos;this.itemDetail=[],a&&(this.item.CONCEPTO=o.conceptos[0].concepto,a.forEach(d=>{var p,g,h={};h.FOLIO=o.folio,h.CASA=o.casa,h.NOMBRE=o.nombre,h.CONCEPTO=d.concepto,h.MES=d.mes,h.MONTO=d.monto,h.PREFIX=null!==(p=null===(g=o.prefijo)||void 0===g?void 0:g.PREFIX)&&void 0!==p?p:"",this.itemDetail.push(h)}))}removeInputField(o){this.fields.controls.conceptos.removeAt(o)}addNewInputField(){this.fields.controls.conceptos.push(this.frmConceptos())}meesageToast(o){this.toastUtil.presentToast(o,"top")}confirm(o){this.modalCtrl.dismiss(o,"confirm")}close(){this.modalCtrl.dismiss(null,"cancel")}}(_=b).\u0275fac=function(o){return new(o||_)(e.rXU(s.W3),e.rXU(s.GD),e.rXU(r.ok),e.rXU(E.f),e.rXU(O.L),e.rXU(m.w),e.rXU(u.l))},_.\u0275cmp=e.VBU({type:_,selectors:[["app-add-recibos"]],standalone:!1,decls:34,vars:5,consts:[["slot","start"],[3,"click"],["name","close"],[1,"ion-padding"],[3,"ngSubmit","formGroup"],[4,"ngIf"],["label","Folio","labelPlacement","floating","id","folio","type","number","formControlName","folio"],["label","Fecha","labelPlacement","floating","id","fecha","type","date","formControlName","fecha"],["label","Casa","labelPlacement","floating","id","casa","interface","popover","formControlName","casa",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["label","Nombre","labelPlacement","floating","id","nombre","type","text","formControlName","nombre"],["label","Email","labelPlacement","floating","id","email","type","email","formControlName","email"],["id","sendEmail","item-right","","secondary","","formControlName","sendEmail","color","green"],["label","Cantidad","labelPlacement","floating","id","cantidad","type","number","formControlName","cantidad"],["slot","start","name","cash","aria-hidden","true"],["formArrayName","conceptos","margin-bottom",""],[3,"formGroupName",4,"ngFor","ngForOf"],["size","small","fill","clear","color","primary",3,"click"],["slot","start","name","add"],["type","submit","expand","block",3,"disabled"],["label","Prefix:","labelPlacement","floating","interface","popover","id","prefijo","formControlName","prefijo",3,"ionChange"],[3,"value"],[3,"formGroupName"],["color","light"],["label","Concepto:","labelPlacement","floating","interface","popover","id","concepto","formControlName","concepto",3,"ionChange"],["floating",""],["id","mes","displayFormat","MMM. YYYY","formControlName","mes","monthShortNames","Ene, Feb, Mar, Apr, May, Jun, Jul, Ago, Sep, Oct, Nov, Dic","presentation","month-year",3,"preferWheel"],["label","Monto:","labelPlacement","floating","id","monto","type","number","maxlength","50","formControlName","monto"],["size","small","fill","clear","color","danger",3,"click",4,"ngIf"],["size","small","fill","clear","color","danger",3,"click"]],template:function(o,t){1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Agregar Recibos"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return t.close()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"form",4),e.bIt("ngSubmit",function(){return t.onSave(t.fields.value)}),e.DNE(9,M,3,1,"ion-item",5),e.j41(10,"ion-item"),e.nrm(11,"ion-input",6),e.k0s(),e.j41(12,"ion-item"),e.nrm(13,"ion-input",7),e.k0s(),e.j41(14,"ion-item")(15,"ion-select",8),e.bIt("ionChange",function(n){return t.onChangeCasa(n)}),e.DNE(16,I,2,3,"ion-select-option",9),e.nrm(17,"ion-select-option")(18,"ion-select-option"),e.k0s()(),e.j41(19,"ion-item"),e.nrm(20,"ion-input",10),e.k0s(),e.j41(21,"ion-item"),e.nrm(22,"ion-input",11)(23,"ion-checkbox",12),e.k0s(),e.j41(24,"ion-item")(25,"ion-input",13),e.nrm(26,"ion-icon",14),e.k0s()(),e.j41(27,"div",15),e.DNE(28,A,14,5,"section",16),e.k0s(),e.j41(29,"ion-button",17),e.bIt("click",function(){return t.addNewInputField()}),e.nrm(30,"ion-icon",18),e.EFF(31," nuevo concepto "),e.k0s(),e.j41(32,"ion-button",19),e.EFF(33,"Agregar"),e.k0s()()()),2&o&&(e.R7$(8),e.Y8G("formGroup",t.fields),e.R7$(),e.Y8G("ngIf","admin"===(null==t.user?null:t.user.ROLE)||"dev"===(null==t.user?null:t.user.ROLE)||"manager"===(null==t.user?null:t.user.ROLE)),e.R7$(7),e.Y8G("ngForOf",t.casas),e.R7$(12),e.Y8G("ngForOf",t.conceptoForm.controls),e.R7$(4),e.Y8G("disabled",!t.fields.valid))},dependencies:[C.Sq,C.bT,r.qT,r.BC,r.cb,r.tU,s.Jm,s.QW,s.eY,s.W9,s.A9,s.eU,s.iq,s.$w,s.uz,s.Dg,s.jh,s.he,s.Nm,s.Ip,s.BC,s.ai,s.hB,s.su,s.Je,s.Gw,r.j4,r.JD,r.$R,r.v8],styles:["ion-select[_ngcontent-%COMP%]{min-width:100%;padding-left:0}\n\n/*# sourceMappingURL=add-recibos.component.css.map*/"]})},7578:(D,v,c)=>{c.d(v,{l:()=>E});var s,f=c(9204),r=c(7404),e=c(9618);class E{constructor(m){this.alertCtrl=m}showSucess(m){var u=this;return(0,f.A)(function*(){yield(yield u.alertCtrl.create({header:"Exito",message:m,buttons:["OK"]})).present(),console.log("Success:",m)})()}showError(m){var u=this;return(0,f.A)(function*(){yield(yield u.alertCtrl.create({header:"Error",message:m,buttons:["OK"]})).present(),console.error("Error:",m)})()}}(s=E).\u0275fac=function(m){return new(m||s)(r.KVO(e.hG))},s.\u0275prov=r.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}}]);
//# sourceMappingURL=4885.0a3bf79c5e06e744.js.map