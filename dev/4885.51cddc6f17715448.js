"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4885],{4885:(R,O,c)=>{c.d(O,{c:()=>b});var g,_=c(9204),a=c(496),e=c(7404),r=c(9618),E=c(4735),v=c(7568),m=c(3511),f=c(7578),C=c(316);function D(l,t){if(1&l&&(e.j41(0,"ion-select-option",22),e.EFF(1),e.k0s()),2&l){const o=t.$implicit;e.Y8G("value",o),e.R7$(),e.SpI(" ",o.NOMBRE," ")}}function M(l,t){if(1&l){const o=e.RV6();e.j41(0,"ion-item",20)(1,"ion-select",21),e.bIt("ionChange",function(n){e.eBV(o);const s=e.XpG();return e.Njj(s.onChangePrefijo(n))}),e.DNE(2,D,2,2,"ion-select-option",9),e.k0s()()}if(2&l){const o=e.XpG();e.R7$(2),e.Y8G("ngForOf",o.prefijos)}}function F(l,t){if(1&l&&(e.j41(0,"ion-select-option",22),e.EFF(1),e.k0s()),2&l){const o=t.$implicit;e.Y8G("value",o),e.R7$(),e.Lme("",o.ID,"--",o.NOMBRE," ")}}function I(l,t){if(1&l&&(e.j41(0,"ion-select-option",22),e.EFF(1),e.k0s()),2&l){const o=t.$implicit;e.Y8G("value",o.NOMBRE),e.R7$(),e.SpI(" ",o.NOMBRE," ")}}function A(l,t){if(1&l){const o=e.RV6();e.j41(0,"ion-button",30),e.bIt("click",function(){e.eBV(o);const n=e.XpG().index,s=e.XpG();return e.Njj(s.removeInputField(n))}),e.nrm(1,"ion-icon",2),e.EFF(2," eliminar "),e.k0s()}}function N(l,t){if(1&l){const o=e.RV6();e.j41(0,"section",23)(1,"ion-item-group")(2,"ion-item-divider",24),e.EFF(3),e.k0s(),e.j41(4,"ion-item")(5,"ion-select",25),e.bIt("ionChange",function(n){const s=e.eBV(o).index,d=e.XpG();return e.Njj(d.onChangeConcepto(n,s))}),e.DNE(6,I,2,2,"ion-select-option",9),e.k0s()(),e.j41(7,"ion-item")(8,"ion-label",26),e.EFF(9,"Mes:"),e.k0s(),e.nrm(10,"ion-datetime",27),e.k0s(),e.j41(11,"ion-item"),e.nrm(12,"ion-input",28),e.k0s(),e.DNE(13,A,3,0,"ion-button",29),e.k0s()()}if(2&l){const o=t.index,i=e.XpG();e.Y8G("formGroupName",o),e.R7$(3),e.SpI("Conceptos #",o+1,""),e.R7$(3),e.Y8G("ngForOf",i.conceptos),e.R7$(4),e.Y8G("preferWheel",!0),e.R7$(3),e.Y8G("ngIf",i.conceptoForm.length>1)}}class b{constructor(t,o,i,n,s,d,p){this.modalCtrl=t,this.actionSheetCtrl=o,this.formBuilder=i,this.service=n,this.loadingUtil=s,this.toastUtil=d,this.alertUtil=p,this.user=null,this.item={FOLIO:0,CASA:"",NOMBRE:"",CANTIDAD:"",CONCEPTO:"",FECHA:"",CORREO:"",INPUT_TIMESTAMP:"",PREFIX:""},this.itemDetail=[],this.casas=[],this.conceptos=[],this.prefijos=[],this.data=!1,this.sendEmail=!1,this.date=new Date,this.today=new Date(this.date.getTime()-6e4*this.date.getTimezoneOffset()),this.fields=this.formBuilder.group({prefijo:["",a.k0.required],folio:["",a.k0.required],casa:["",a.k0.required],nombre:["",a.k0.required],fecha:["",a.k0.required],email:["",a.k0.required],sendEmail:"",cantidad:["",a.k0.required],conceptos:this.formBuilder.array([this.frmConceptos()])})}frmConceptos(){return this.formBuilder.group({concepto:["",[a.k0.required,a.k0.minLength(3)]],mes:["",[a.k0.required]],monto:["",[a.k0.required,a.k0.min(0),a.k0.pattern(/^\d+(\.\d{1,2})?$/)]]})}get conceptoForm(){return this.fields.get("conceptos")}ngOnInit(){this.service.getSpreadSheetId().then(()=>{const t=this.today.toJSON().split("T")[0];this.fields.patchValue({fecha:t}),this.inittial()}),this.loadingUtil.showing()}getMaxFolio(){this.service.getFullDataDetail().subscribe({next:t=>{const o=Math.max(...t.map(i=>i.FOLIO))+1;this.fields.patchValue({folio:o}),this.loadingUtil.dismiss()},error:t=>{this.fields.patchValue({folio:1}),this.loadingUtil.dismiss(),this.alertUtil.showError("No se pudo obtener el folio: "+t.message)}})}inittial(){var t=this;const o=localStorage.getItem("user");var i;this.user=o?JSON.parse(o):null,this.service.getFullData().subscribe({next:i=>{this.casas=i||[],this.service.getConceptos().subscribe(n=>{this.conceptos=n||[]}),this.service.getPrefijos().subscribe(n=>{this.prefijos=n||[];let s=this.prefijos.find(d=>{var p,u,h;return(null===(p=d.NOMBRE)||void 0===p?void 0:p.toUpperCase())===(null===(u=this.user)||void 0===u||null===(u=u.ID)||void 0===u?void 0:u.toUpperCase())&&"user"===(null===(h=this.user)||void 0===h?void 0:h.ROLE)});s&&this.fields.patchValue({prefijo:s.NOMBRE,folio:(null==s?void 0:s.FOLIO)+1}),this.loadingUtil.dismiss()})},error:(i=(0,_.A)(function*(n){console.error("Error al cargar datos:",n),t.loadingUtil.dismiss(),t.alertUtil.showError("No se pudieron cargar los datos: "+n.message)}),function(s){return i.apply(this,arguments)})})}onChangeCasa(t){const o=t.detail.value;o.ID&&(this.casa=this.casas.find(i=>i.ID===o.ID&&i.NOMBRE===o.NOMBRE?i:null),this.fields.patchValue({nombre:this.casa.NOMBRE,email:this.casa.EMAIL,sendEmail:!0}))}onChangePrefijo(t){var o;const i=t.detail.value;if(!i)return;let n=this.prefijos.find(s=>s.NOMBRE===i.NOMBRE);this.fields.patchValue({folio:(null!==(o=null==n?void 0:n.FOLIO)&&void 0!==o?o:0)+1})}onChangeConcepto(t,o){if(t.detail.value){const n=this.fields.controls.conceptos;let s=this.calMontoConcepto();n.at(o).patchValue({mes:this.getFirstDayOfMonth(),monto:s})}}calMontoConcepto(){const t=this.fields.controls.conceptos;let o=0;return t.controls.forEach(i=>{o+=i.value.monto}),this.fields.value.cantidad-o}getFirstDayOfMonth(){return new Date(this.today.getFullYear(),this.today.getMonth(),1).toJSON().split("T")[0]}onSave(t){var o=this;return(0,_.A)(function*(){yield(yield o.actionSheetCtrl.create({header:"\xbfDesea guardar el recibo?",buttons:[{text:"Aceptar",role:"confirm",icon:"checkmark",handler:()=>{o.save(t)}},{text:"Cancelar",role:"cancel",icon:"close"}]})).present()})()}save(t){var o,i;let n=t.casa;t.casa=n.ID;let s=null!==(o=null===(i=t.prefijo)||void 0===i?void 0:i.PREFIJO)&&void 0!==o?o:"";t.prefijo=s,this.fillEvent(t),this.service.save(this.item,this.itemDetail).subscribe({next:d=>{if(this.sendEmail){let p=new Date(t.fecha),u=new Date(p.getTime()+6e4*this.date.getTimezoneOffset());t.fecha=u.toLocaleDateString(),this.service.sendEmail(t,t.conceptos).subscribe({next:h=>{this.meesageToast("correo enviado")},error:h=>{console.log("Error email: ",h)}})}this.meesageToast("Se guardo exitosamente"),this.loadingUtil.dismiss(),this.itemDetail=this.convertMonth(this.itemDetail),this.confirm(this.itemDetail)},error:d=>{this.meesageToast("No se pudo guardar el dato"),this.loadingUtil.dismiss()}}),this.loadingUtil.showing(),t.sendEmail=!0}convertMonth(t){return t.map(o=>{var i;const[n,s,d]=(null===(i=o.MES)||void 0===i?void 0:i.split("-"))||[],p=`${n}-${s}-${d}T06:00:00.000Z`;return{...o,MES:p}})}fillEvent(t){this.item.FOLIO=t.folio;new Date(t.fecha);this.item.FECHA=t.fecha,this.item.CASA=t.casa,this.item.NOMBRE=t.nombre,this.item.CORREO=t.email,this.item.CANTIDAD=t.cantidad,this.item.PREFIX=t.prefijo;var i=t.conceptos;this.itemDetail=[],i&&(this.item.CONCEPTO=t.conceptos[0].concepto,i.forEach(n=>{var s={};s.FOLIO=t.folio,s.CASA=t.casa,s.NOMBRE=t.nombre,s.CONCEPTO=n.concepto,s.MES=n.mes,s.MONTO=n.monto,s.PREFIX=t.prefijo,this.itemDetail.push(s)}))}removeInputField(t){this.fields.controls.conceptos.removeAt(t)}addNewInputField(){this.fields.controls.conceptos.push(this.frmConceptos())}meesageToast(t){this.toastUtil.presentToast(t,"top")}confirm(t){this.modalCtrl.dismiss(t,"confirm")}close(){this.modalCtrl.dismiss(null,"cancel")}}(g=b).\u0275fac=function(t){return new(t||g)(e.rXU(r.W3),e.rXU(r.GD),e.rXU(a.ok),e.rXU(E.f),e.rXU(v.L),e.rXU(m.w),e.rXU(f.l))},g.\u0275cmp=e.VBU({type:g,selectors:[["app-add-recibos"]],standalone:!1,decls:34,vars:5,consts:[["slot","start"],[3,"click"],["name","close"],[1,"ion-padding"],[3,"ngSubmit","formGroup"],["disabled","",4,"ngIf"],["label","Folio","labelPlacement","floating","id","folio","type","number","formControlName","folio"],["label","Fecha","labelPlacement","floating","id","fecha","type","date","formControlName","fecha"],["label","Casa","labelPlacement","floating","id","casa","interface","popover","formControlName","casa",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["label","Nombre","labelPlacement","floating","id","nombre","type","text","formControlName","nombre"],["label","Email","labelPlacement","floating","id","email","type","email","formControlName","email"],["id","sendEmail","item-right","","secondary","","formControlName","sendEmail","color","green"],["label","Cantidad","labelPlacement","floating","id","cantidad","type","number","formControlName","cantidad"],["slot","start","name","cash","aria-hidden","true"],["formArrayName","conceptos","margin-bottom",""],[3,"formGroupName",4,"ngFor","ngForOf"],["size","small","fill","clear","color","primary",3,"click"],["slot","start","name","add"],["type","submit","expand","block",3,"disabled"],["disabled",""],["label","Prefix:","labelPlacement","floating","interface","popover","id","prefijo","formControlName","prefijo",3,"ionChange"],[3,"value"],[3,"formGroupName"],["color","light"],["label","Concepto:","labelPlacement","floating","interface","popover","id","concepto","formControlName","concepto",3,"ionChange"],["floating",""],["id","mes","displayFormat","MMM. YYYY","formControlName","mes","monthShortNames","Ene, Feb, Mar, Apr, May, Jun, Jul, Ago, Sep, Oct, Nov, Dic","presentation","month-year",3,"preferWheel"],["label","Monto:","labelPlacement","floating","id","monto","type","number","maxlength","50","formControlName","monto"],["size","small","fill","clear","color","danger",3,"click",4,"ngIf"],["size","small","fill","clear","color","danger",3,"click"]],template:function(t,o){1&t&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Agregar Recibos"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return o.close()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"form",4),e.bIt("ngSubmit",function(){return o.onSave(o.fields.value)}),e.DNE(9,M,3,1,"ion-item",5),e.j41(10,"ion-item"),e.nrm(11,"ion-input",6),e.k0s(),e.j41(12,"ion-item"),e.nrm(13,"ion-input",7),e.k0s(),e.j41(14,"ion-item")(15,"ion-select",8),e.bIt("ionChange",function(n){return o.onChangeCasa(n)}),e.DNE(16,F,2,3,"ion-select-option",9),e.nrm(17,"ion-select-option")(18,"ion-select-option"),e.k0s()(),e.j41(19,"ion-item"),e.nrm(20,"ion-input",10),e.k0s(),e.j41(21,"ion-item"),e.nrm(22,"ion-input",11)(23,"ion-checkbox",12),e.k0s(),e.j41(24,"ion-item")(25,"ion-input",13),e.nrm(26,"ion-icon",14),e.k0s()(),e.j41(27,"div",15),e.DNE(28,N,14,5,"section",16),e.k0s(),e.j41(29,"ion-button",17),e.bIt("click",function(){return o.addNewInputField()}),e.nrm(30,"ion-icon",18),e.EFF(31," nuevo concepto "),e.k0s(),e.j41(32,"ion-button",19),e.EFF(33,"Agregar"),e.k0s()()()),2&t&&(e.R7$(8),e.Y8G("formGroup",o.fields),e.R7$(),e.Y8G("ngIf","admin"===(null==o.user?null:o.user.ROLE)||"dev"===(null==o.user?null:o.user.ROLE)||"manager"===(null==o.user?null:o.user.ROLE)),e.R7$(7),e.Y8G("ngForOf",o.casas),e.R7$(12),e.Y8G("ngForOf",o.conceptoForm.controls),e.R7$(4),e.Y8G("disabled",!o.fields.valid))},dependencies:[C.Sq,C.bT,a.qT,a.BC,a.cb,a.tU,r.Jm,r.QW,r.eY,r.W9,r.A9,r.eU,r.iq,r.$w,r.uz,r.Dg,r.jh,r.he,r.Nm,r.Ip,r.BC,r.ai,r.hB,r.su,r.Je,r.Gw,a.j4,a.JD,a.$R,a.v8],styles:["ion-select[_ngcontent-%COMP%]{min-width:100%;padding-left:0}\n\n/*# sourceMappingURL=add-recibos.component.css.map*/"]})},7578:(R,O,c)=>{c.d(O,{l:()=>E});var r,_=c(9204),a=c(7404),e=c(9618);class E{constructor(m){this.alertCtrl=m}showSucess(m){var f=this;return(0,_.A)(function*(){yield(yield f.alertCtrl.create({header:"Exito",message:m,buttons:["OK"]})).present(),console.log("Success:",m)})()}showError(m){var f=this;return(0,_.A)(function*(){yield(yield f.alertCtrl.create({header:"Error",message:m,buttons:["OK"]})).present(),console.error("Error:",m)})()}}(r=E).\u0275fac=function(m){return new(m||r)(a.KVO(e.hG))},r.\u0275prov=a.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}}]);
//# sourceMappingURL=4885.51cddc6f17715448.js.map